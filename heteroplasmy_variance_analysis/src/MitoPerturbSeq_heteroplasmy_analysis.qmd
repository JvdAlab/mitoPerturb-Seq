---
title: "MitoPerturbSeq heteroplasmy analysis"
author: "Abhilesh Dhawanjewar"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
format:
    html:
        code-fold: true
        embed-resources: true
        df-print: kable
execute:
    echo: false
    warning: false
---

```{r}
#| label: setup
#| include: false

knitr::opts_chunk$set(
    echo = FALSE,
    message = FALSE,
    warning = FALSE,
    fig.align = "center"
)

# Manage conflicts
library(conflicted)

# Set preference for conflicts
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::filter)
conflicts_prefer(plotly::layout)

# Core packages
library(here)
library(stringr)
library(tidyverse)
library(broom)

# Visualization
library(patchwork)
library(ggridges)
library(quantreg)
library(ggrepel)
library(scales)
library(shades)
library(plotly)
library(paletteer)

# Tables
library(knitr)
library(kableExtra)

# Statistical analysis
library(car)
library(quantreg)

data_dir <- here("data")
plot_dir <- here("figures", "mtDNA_heteroplasmy_analysis")

if (!dir.exists(plot_dir)) {
    dir.create(plot_dir, recursive = TRUE)
}

# Set the seed for reproducibility
set.seed(1234)
```

```{r}
#| label: load-data
#| echo: true
#| code-summary: "Load and preprocess data"

# Load data
mtDNA_data <- read.csv(
    here(data_dir, "integrated_dataset_metadata.csv"))
# There are 76 rows with heteroplasmy values as NAs

# Load mixscape data
mixscape_data <- read.csv(
    here(data_dir, "integrated_mixscape_metadata.csv"))

# This function predicts technical measurement variance based on mtDNA depth and is used for empirical weighting in linear models
het_sim_df <- readRDS(
    here(data_dir, "het_depth_sim.rds")
)
get_measurement_variance <- readRDS(
    here(data_dir, "measurement_variance_function.rds")
)

# Change labels for "Park2" and "Nontargeting"
mtDNA_data$top_guide_final_enrich_combined <-   mtDNA_data$top_guide_final_enrich_combined %>%
    replace(mtDNA_data$top_guide_final_enrich_combined == "Park2", "Prkn") %>%
    replace(mtDNA_data$top_guide_final_enrich_combined == "Nontargeting", "NT")

gRNA_order <- c(
        "Akap1",
        "Nnt",
        "Polg",
        "Tfam",
        "Dnm1l",
        "Mtfp1",
        "Opa1",
        "Snx9",
        "Atg5",
        "Oma1",
        "Pink1",
        "Ppargc1a",
        "Prkn",
        "Eomes",
        "Neurod1",
        "Olig1",
        "Opn4",
        "Rgr",
        "Rrh",
        "NT"
    )

# Order the factor levels
mtDNA_data$top_guide_final_enrich_combined <- factor(
    mtDNA_data$top_guide_final_enrich_combined,
    levels = gRNA_order
)

mtDNA_data_by_gRNA <- mtDNA_data %>%
    group_by(top_guide_final_enrich_combined) %>%
    dplyr::summarise(
        mean_het = mean(Heteroplasmy_all_5024, na.rm = TRUE),
        var_het = var(Heteroplasmy_all_5024, na.rm = TRUE),
        mean_depth = mean(mtDNA_depth, na.rm = TRUE),
        n_cells = n()
    ) %>%
    arrange(desc(mean_het))

# Add group labels to the gRNA genes
mtDNA_data_by_gRNA <- mtDNA_data_by_gRNA %>%
    dplyr::mutate(group = top_guide_final_enrich_combined)

mtDNA_data_by_gRNA$group <- factor(
    mtDNA_data_by_gRNA$group,
    levels = gRNA_order
)

mtDNA_data_by_gRNA <- mtDNA_data_by_gRNA %>%
    dplyr::mutate(func_group = case_when(
        group %in% c("Akap1", "Nnt", "Polg", "Tfam") ~ "Maintanence Genes",
        group %in% c("Dnm1l", "Mtfp1", "Opa1", "Snx9") ~ "Fission/Fusion",
        group %in% c("Atg5", "Oma1", "Pink1", "Ppargc1a", "Prkn") ~ "Mitophagy",
        group %in% c("Eomes", "Neurod1", "Olig1", "Opn4", "Rgr", "Rrh", "NT") ~ "Control"
    ))

# Add a grouping variable to the gRNA genes
mtDNA_data <- mtDNA_data %>%
    dplyr::mutate(group = case_when(
        top_guide_final_enrich_combined %in% c("Akap1", "Nnt", "Polg", "Tfam") ~ "Maintanence Genes",
        top_guide_final_enrich_combined %in% c("Dnm1l", "Mtfp1", "Opa1", "Snx9") ~ "Fission/Fusion",
        top_guide_final_enrich_combined %in% c("Atg5", "Oma1", "Pink1", "Ppargc1a", "Prkn") ~ "Mitophagy",
        top_guide_final_enrich_combined %in% c("Eomes", "Neurod1", "Olig1", "Opn4", "Rgr", "Rrh", "NT") ~ "Control"
    ))

mtDNA_data$group <- factor(
    mtDNA_data$group,
    levels = c("Maintanence Genes", "Fission/Fusion", "Mitophagy", "Control")
)

# Define colors for the gRNAs
col_pal <- paletteer_d("ggsci::category20_d3")
names(col_pal) <- gRNA_order

# Highlight color
custom_salmon <- saturation("#FA8072", 0.4)

```

### Distributions of mtDNA depth and heteroplasmy

```{r}
#| label: fig-ridge-plots
#| fig-cap: "Ridge plots showing heteroplasmy distributions across gRNAs. TFAM, POLG, and OPA1 show broader distributions."
#| fig-width: 10
#| fig-height: 8
#| fig-align: center
#| fig-fullwidth: true

plot_ridge <- function(data, y_var, x_var) {
    ggplot(data, aes_string(x = y_var, y = x_var, fill = x_var)) +
        geom_density_ridges() +
        ylab("Guide RNAs") +
        theme_minimal() +
        theme(
            legend.position = "none",
            axis.text.x = element_text(angle = 90, hjust = 1),
            axis.title.x = element_text(margin = margin(t = 10)),
        ) +
        scale_fill_manual(values = col_pal)
}

het_ridge_plot <- plot_ridge(
    mtDNA_data,
    "Heteroplasmy_all_5024",
    "top_guide_final_enrich_combined") +
    xlim(0, 1.0)

depth_ridge_plot <- plot_ridge(
    mtDNA_data,
    "mtDNA_depth",
    "top_guide_final_enrich_combined")

(het_ridge_plot + depth_ridge_plot) +
    plot_layout(axes = "collect")
```

### Applying mtDNA depth cutoff > 20

In-silico modelling of heteroplasmy calling based on sub-sampling of a simulated heteroplasmic mtDNA population suggested an increase in sampling noise at mtDNA depths < 20. However, the most dramatic perturbations (TFAM, POLG, OPA1) also exhibit significant mtDNA copy number reduction.

```{r}
#| label: fig-depth-threshold-by-gRNA
#| fig-cap: "Number of cells and proportion passing mtDNA depth > 20 threshold by gRNA. Top panel shows total cells (blue) and cells passing threshold (green). Bottom panel shows proportion passing threshold. TFAM, POLG, and OPA1 show the largest drops in cells passing threshold."
#| fig-align: center
#| fig-fullwidth: true

# Summarize the total number of cells and the number of cells passing the mtDNA_depth > 20 threshold
gRNA_cell_counts <- mtDNA_data %>%
    group_by(top_guide_final_enrich_combined) %>%
    dplyr::summarise(
        total_cells = n(),
        cells_passing_threshold = sum(mtDNA_depth > 20, na.rm = TRUE)
    ) %>%
    dplyr::mutate(
        proportion_passing = cells_passing_threshold / total_cells
    ) %>%
    arrange(desc(total_cells))

# Order gRNAs by decreasing proportion passing
gRNA_cell_counts <- gRNA_cell_counts %>%
    dplyr::mutate(
        top_guide_final_enrich_combined = reorder(top_guide_final_enrich_combined, -proportion_passing)
    )

# Create a long-format data frame for plotting
gRNA_cell_counts_long <- gRNA_cell_counts %>%
    tidyr::pivot_longer(
        cols = c(total_cells, cells_passing_threshold),
        names_to = "cell_type",
        values_to = "count"
    ) %>%
    # Explicitly set the factor levels for cell_type
    dplyr::mutate(
        cell_type = factor(cell_type, levels = c("total_cells", "cells_passing_threshold"))
    )

# Create the bar chart for total cells and cells passing threshold
gRNA_barchart <- ggplot(gRNA_cell_counts_long, aes(
    x = top_guide_final_enrich_combined,
    y = count,
    fill = cell_type
)) +
    geom_bar(stat = "identity", position = "identity", width = 0.8, alpha = 0.8) +
    scale_fill_manual(
        values = c(
            "total_cells" = col_pal[["Akap1"]],
            "cells_passing_threshold" = col_pal[["Prkn"]]
        ),
        labels = c("Total Cells", "Cells Passing Threshold")
    ) +
    theme_minimal() +
    theme(
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.title = element_blank()
    ) +
    labs(
        x = NULL,
        y = "Number of Cells",
        title = "Total Cells and Cells Passing mtDNA Depth > 20 Threshold"
    )

# Create the bar chart for proportion passing
proportion_barchart <- ggplot(gRNA_cell_counts, aes(
    x = top_guide_final_enrich_combined,
    y = proportion_passing
)) +
    geom_bar(
        stat = "identity",
        fill = col_pal[["Polg"]],
        width = 0.8,
        alpha = 0.8
    ) +
    ylim(0, 1) +
    theme_minimal() +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none"
    ) +
    labs(
        x = "gRNA",
        y = "Proportion Passing",
        title = "Proportion of Cells Passing mtDNA Depth > 20 Threshold"
    )

# Combine the two plots using patchwork and share the legend at the bottom
combined_plot <- (gRNA_barchart / proportion_barchart) +
    plot_layout(heights = c(2, 1), guides = "collect") +
    plot_annotation() & theme(legend.position = "bottom")

combined_plot

ggsave(
    here::here(plot_dir, "mtDNA_cells_passing_depth_threshold_by_gRNA.pdf"),
    plot = combined_plot,
    width = 10,
    height = 8
)
```

The gRNAs associated with mtDNA copy number reduction also show the greatest drop of cells passing the mtDNA depth > 20 threshold.

| gRNA   | Total Cells | Cells Passing Threshold | Proportion Passing |
|:-------|------------:|-----------------------:|------------------:|
| `Tfam` | `r gRNA_cell_counts$total_cells[gRNA_cell_counts$top_guide_final_enrich_combined == "Tfam"]` | `r gRNA_cell_counts$cells_passing_threshold[gRNA_cell_counts$top_guide_final_enrich_combined == "Tfam"]` | `r round(gRNA_cell_counts$proportion_passing[gRNA_cell_counts$top_guide_final_enrich_combined == "Tfam"], 2)` |
| `Polg` | `r gRNA_cell_counts$total_cells[gRNA_cell_counts$top_guide_final_enrich_combined == "Polg"]` | `r gRNA_cell_counts$cells_passing_threshold[gRNA_cell_counts$top_guide_final_enrich_combined == "Polg"]` | `r round(gRNA_cell_counts$proportion_passing[gRNA_cell_counts$top_guide_final_enrich_combined == "Polg"], 2)` |
| `Opa1`  | `r gRNA_cell_counts$total_cells[gRNA_cell_counts$top_guide_final_enrich_combined == "Opa1"]`  | `r gRNA_cell_counts$cells_passing_threshold[gRNA_cell_counts$top_guide_final_enrich_combined == "Opa1"]`  | `r round(gRNA_cell_counts$proportion_passing[gRNA_cell_counts$top_guide_final_enrich_combined == "Opa1"], 2)`  |

Applying a read depth threshold increases the accuracy of the per-cell heteroplasmy calls, which is an important consideration for downstream analyses that aim to identify subtle shifts in mean heteroplasmy. However, in the context of gene perturbations that result in a depletion of mtDNA copy number, it also risks losing genuine biological signal by excluding the cells with the most pronounced perturbations.

### Heteroplasmy variance by gRNA

```{r}
#| label: fig-het-variance-by-gRNA
#| fig-cap: "Bar plot showing the variance of heteroplasmy levels across different gRNA perturbations."
#| fig-align: center
#| fig-fullwidth: true

# Calculate variance - No cutoff
het_variance_no_cutoff <- mtDNA_data %>%
    group_by(top_guide_final_enrich_combined) %>%
    dplyr::summarise(variance = var(Heteroplasmy_all_5024, na.rm = TRUE)) %>%
    arrange(variance)

# Calculate variance - Depth > 20 cutoff
het_variance_cutoff <- mtDNA_data %>%
    filter(mtDNA_depth > 20) %>%
    group_by(top_guide_final_enrich_combined) %>%
    dplyr::summarise(variance = var(Heteroplasmy_all_5024, na.rm = TRUE)) %>%
    arrange(variance)

# Determine consistent y-axis order based on no-cutoff variance
gRNA_order <- het_variance_no_cutoff %>%
    arrange(variance) %>%
    pull(top_guide_final_enrich_combined)

# Create plot 1: No cutoff
variance_plot_no_cutoff <- ggplot(
    het_variance_no_cutoff,
    aes(
        y = factor(top_guide_final_enrich_combined, levels = gRNA_order),
        x = variance,
        fill = top_guide_final_enrich_combined
    )) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    theme(
        legend.position = "none",
        axis.text.x = element_text(angle = 0, hjust = 1)) +
    ylab("Guide RNAs") +
    xlab("Heteroplasmy Variance") +
    scale_fill_manual(values = col_pal) +
    ggtitle("No Depth Cutoff")

# Create plot 2: Depth > 20
variance_plot_cutoff <- ggplot(
    het_variance_cutoff,
    aes(
        y = factor(top_guide_final_enrich_combined, levels = gRNA_order),
        x = variance,
        fill = top_guide_final_enrich_combined
    )) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    theme(
        legend.position = "none",
        axis.text.x = element_text(angle = 0, hjust = 1),
        axis.text.y = element_blank(),  # Remove y-axis labels on right plot
        axis.title.y = element_blank()   # Remove y-axis title on right plot
    ) +
    xlab("Heteroplasmy Variance") +
    scale_fill_manual(values = col_pal) +
    ggtitle("mtDNA Depth > 20")

# Combine with patchwork
combined_variance_plot <- variance_plot_no_cutoff + variance_plot_cutoff

ggsave(
    here(plot_dir, "mtDNA_het_variance_by_gRNA_mirrored.pdf"),
    plot = combined_variance_plot,
    width = 14,
    height = 6
)

combined_variance_plot
```

We used the Brown-Forsythe test to compare heteroplasmy variance between each gRNA and the `NT` cells. P-values were adjusted for multiple testing using the Holm method. Significant results (p.adj.holm < 0.05) are highlighted in the table below.

```{r}
#| label: brown-forsythe-test-het-variance
#| echo: true
#| code-summary: "Pairwise Brown-Forsythe test for heteroplasmy variance between each gRNA and Non-targeting cells"

run_bf_analysis <- function(data,
                            group_col = "top_guide_final_enrich_combined",
                            value_col = "Heteroplasmy_all_5024",
                            control_label = "NT") {

    # Isolate Control Data
    nt_data <- data %>% filter(.data[[group_col]] == control_label)

    # Global Safety Check: If control has too few points, abort early
    if (nrow(nt_data) < 2) {
        warning("Control group has insufficient data (<2 rows). Returning NULL.")
        return(NULL)
    }

    # Identify Test Groups
    test_data <- data %>% filter(.data[[group_col]] != control_label)
    test_groups <- unique(test_data[[group_col]])

    # Run Tests
    map_dfr(test_groups, function(gRNA) {

        # Isolate current target
        current_target <- test_data %>% filter(.data[[group_col]] == gRNA)

        # Local Safety Check
        if (nrow(current_target) < 2) {
            return(data.frame(gRNA = as.character(gRNA), p_value = NA))
        }

        pair_data <- bind_rows(current_target, nt_data) %>%
            mutate(Group = factor(
                ifelse(.data[[group_col]] == gRNA,
                "Target", "Control")))

        # Levene's Test (Brown-Forsythe center=median)
        bf_test <- tryCatch({
            leveneTest(
                as.formula(paste(value_col, "~ Group")),
                data = pair_data,
                center = median)
        }, error = function(e) NULL)

        p_val <- if (!is.null(bf_test)) bf_test$`Pr(>F)`[1] else NA

        data.frame(gRNA = as.character(gRNA), p_value = p_val)

    }) %>%
        filter(!is.na(p_value)) %>%
        mutate(
        p.adj.holm = p.adjust(p_value, method = "holm"),
        significant = p.adj.holm < 0.05
        ) %>%
        arrange(p.adj.holm)
    }


# Base cleaning
clean_mtDNA <- mtDNA_data %>%
    drop_na(Heteroplasmy_all_5024)

# Create the subset for the cutoff (Depth > 20)
clean_mtDNA_cutoff <- clean_mtDNA %>%
    filter(mtDNA_depth > 20)

# Run without cutoff
bf_results_no_cutoff <- run_bf_analysis(clean_mtDNA)

# Run with cutoff
bf_results_w_cutoff <- run_bf_analysis(clean_mtDNA_cutoff)
```

```{r}
#| label: brown-forsythe-test-het-variance-display

# Join the two datasets on gRNA
bf_combined <- full_join(
    bf_results_no_cutoff %>%
        select(gRNA, p_val_nc = p_value, padj_nc = p.adj.holm),
    bf_results_w_cutoff %>%
        select(gRNA, p_val_c = p_value, padj_c = p.adj.holm),
    by = "gRNA"
)

# Create formatted string columns for display
bf_display <- bf_combined %>%
    mutate(
        across(starts_with("p"), ~ formatC(.x, format = "e", digits = 2)),
        across(everything(), ~ ifelse(grepl("NA", .x), "-", .x))
    )

bf_display %>%
    { colnames(.) <- rep(" ", ncol(.)); . } %>%
    kbl(
        format = "html",
        caption = "<b>Pairwise Brown-Forsythe Tests",
        align = "c",
        escape = FALSE
    ) %>%
    kable_styling(
        bootstrap_options = c("striped", "hover"),
        full_width = FALSE,
        position = "left"
    ) %>%
    add_header_above(
        c(
            "gRNA" = 1,
            "p-value" = 1,
            "p.adj (Holm)" = 1,
            "p-value" = 1,
            "p.adj (Holm)" = 1
        )
    ) %>%
    add_header_above(
        c(
            " " = 1, # gRNA column
            "No Cutoff" = 2,
            "With Cutoff (Depth > 20)" = 2
        )
    ) %>%
    column_spec(
        3,
        background = ifelse(
            !is.na(bf_combined$padj_nc) & bf_combined$padj_nc < 0.05,
            custom_salmon,
            "white"
        )
    ) %>%
    column_spec(
        5,
        background = ifelse(
            !is.na(bf_combined$padj_c) & bf_combined$padj_c < 0.05,
            custom_salmon,
            "white"
        )
    )
```

<br>

The gRNA KO groups for `Tfam`, `Opa1`, `Polg`, and `Dnm1l` show significantly increased heteroplasmy variance compared to `Control` gRNAs (Holm-adjusted p-value < 0.05).

### Heteroplasmy variance by Mixscape class

Mixscape is a computational method that classifies cells as knockout (KO) or non-perturbed (NP) based on their transcriptional perturbation signature. This classification allows us to distinguish cells with successful gene knockdowns from cells that received the gRNA but show no transcriptional perturbation, providing an internal control for off-target effects within each gRNA group.

```{r}
#| label: fig-mixscape-het-variance
#| fig-cap: "Heteroplasmy variance by Mixscape classification. Bar plot shows variance for knockout (KO) and non-perturbed (NP) cells within each gRNA group. KO cells generally show higher variance than their NP counterparts."
#| fig-align: center
#| fig-fullwidth: true

# Subset to genes of interest - No cutoff
mixscape_data_no_cutoff <- mixscape_data %>%
    filter(str_detect(mixscape_class, "Tfam|Opa1|Polg|Atg5"))

# Subset with depth cutoff
mixscape_data_cutoff <- mixscape_data %>%
    filter(str_detect(mixscape_class, "Tfam|Opa1|Polg|Atg5")) %>%
    filter(mtDNA_depth > 20)

# Calculate variance - No cutoff
mixscape_het_variance_no_cutoff <- mixscape_data_no_cutoff %>%
    group_by(mixscape_class) %>%
    dplyr::summarise(variance = var(Heteroplasmy_all_5024, na.rm = TRUE))

# Calculate variance - With cutoff
mixscape_het_variance_cutoff <- mixscape_data_cutoff %>%
    group_by(mixscape_class) %>%
    dplyr::summarise(variance = var(Heteroplasmy_all_5024, na.rm = TRUE))

# Arrange mixscape classes by variance of KO groups (based on no-cutoff data)
ko_df <- mixscape_het_variance_no_cutoff %>%
    filter(str_detect(mixscape_class, "KO")) %>%
    arrange(desc(variance))

# Build the custom order based on KO variance
custom_order <- unlist(lapply(ko_df$mixscape_class, function(ko_class) {
    gene <- str_remove(ko_class, " KO")
    np_class <- paste0(gene, " NP")
    c(ko_class, np_class)
}))

# Set factor levels for both datasets
mixscape_het_variance_no_cutoff$mixscape_class <- factor(
    mixscape_het_variance_no_cutoff$mixscape_class,
    levels = rev(custom_order)
)

mixscape_het_variance_cutoff$mixscape_class <- factor(
    mixscape_het_variance_cutoff$mixscape_class,
    levels = rev(custom_order)
)

# Set colors for Mixscape classes
if (!is.null(col_pal)) {
    group_colors <- setNames(
        sapply(custom_order, function(class) {
            gene <- str_remove(class, " (KO|NP)")
            sat <- if (str_detect(class, "KO")) 1 else 0.6
            scales::alpha(shades::saturation(col_pal[gene], sat), 0.6)
        }),
        custom_order
    )
}

# Create plot 1: No cutoff
mixscape_variance_plot_no_cutoff <- ggplot(
    mixscape_het_variance_no_cutoff,
    aes(
        y = mixscape_class,
        x = variance,
        fill = mixscape_class
    )) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    theme(
        legend.position = "none",
        axis.text.x = element_text(angle = 0, hjust = 1)) +
    ylab("Mixscape Classes") +
    xlab("Heteroplasmy Variance") +
    scale_fill_manual(values = group_colors) +
    ggtitle("No Depth Cutoff")

# Create plot 2: Depth > 20
mixscape_variance_plot_cutoff <- ggplot(
    mixscape_het_variance_cutoff,
    aes(
        y = mixscape_class,
        x = variance,
        fill = mixscape_class
    )) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    theme(
        legend.position = "none",
        axis.text.x = element_text(angle = 0, hjust = 1),
        axis.text.y = element_blank(),  # Remove y-axis labels on right plot
        axis.title.y = element_blank()   # Remove y-axis title on right plot
    ) +
    xlab("Heteroplasmy Variance") +
    scale_fill_manual(values = group_colors) +
    ggtitle("mtDNA Depth > 20")

# Combine with patchwork
combined_mixscape_variance_plot <- mixscape_variance_plot_no_cutoff + mixscape_variance_plot_cutoff

ggsave(
    here::here(plot_dir, "mtDNA_het_variance_by_mixscape_class_mirrored.pdf"),
    plot = combined_mixscape_variance_plot,
    width = 14,
    height = 6
)

combined_mixscape_variance_plot
```

```{r}
#| label: het-variance-mixscape-ko-vs-np
#| echo: true
#| code-summary: "Pairwise Brown-Forsythe test for Mixscape KO vs NP comparison"

run_mixscape_bf <- function(data,
                            genes,
                            value_col = "Heteroplasmy_all_5024") {

    map_dfr(genes, function(gene) {

        # Define dynamic labels
        ko_label <- paste(gene, "KO")
        np_label <- paste(gene, "NP")

        # Filter data for this specific pair
        gene_data <- data %>%
            filter(mixscape_class %in% c(ko_label, np_label)) %>%
            mutate(Group = factor(ifelse(
            mixscape_class == ko_label, "KO", "NP"
        )))

        # Safety Check: Need at least 2 observations in BOTH groups
        if (sum(gene_data$Group == "KO") < 2 || sum(gene_data$Group == "NP") < 2) {
            return(data.frame(gRNA = gene, p_value = NA))
        }

        # Levene's Test (Brown-Forsythe center=median)
        bf_test <- tryCatch({
            leveneTest(
                as.formula(paste(value_col, "~ Group")),
                data = gene_data,
                center = median
            )
        }, error = function(e) NULL)

        p_val <- if (!is.null(bf_test)) bf_test$`Pr(>F)`[1] else NA

        data.frame(gRNA = gene, p_value = p_val)

    }) %>%
        filter(!is.na(p_value)) %>%
        mutate(
        p.adj.holm = p.adjust(p_value, method = "holm"),
        significant = p.adj.holm < 0.05
        ) %>%
        arrange(p.adj.holm)
    }

# Define genes of interest
genes_of_interest <- c("Tfam", "Opa1", "Polg", "Atg5")

# Filter Mixscape data to relevant rows and remove NAs
mixscape_clean <- mixscape_data %>%
    filter(str_detect(mixscape_class, paste(genes_of_interest, collapse = "|"))) %>%
    drop_na(Heteroplasmy_all_5024)

# Create the subset for the cutoff (Depth > 20)
mixscape_clean_cutoff <- mixscape_clean %>%
    filter(mtDNA_depth > 20)

# Run without cutoff
mixscape_results_no_cutoff <- run_mixscape_bf(
    data = mixscape_clean,
    genes = genes_of_interest
)

# Run with cutoff
mixscape_results_w_cutoff <- run_mixscape_bf(
    data = mixscape_clean_cutoff,
    genes = genes_of_interest
)
```

```{r}

# Join datasets
mixscape_combined <- full_join(
    mixscape_results_no_cutoff %>%
        select(gRNA, p_val_nc = p_value, padj_nc = p.adj.holm),
    mixscape_results_w_cutoff %>%
        select(gRNA, p_val_c = p_value, padj_c = p.adj.holm),
    by = "gRNA"
)

# Create display strings
mixscape_display <- mixscape_combined %>%
    mutate(
        across(starts_with("p"), ~ formatC(.x, format = "e", digits = 2)),
        across(everything(), ~ ifelse(grepl("NA", .x), "-", .x))
    )

mixscape_display %>%
    { colnames(.) <- rep(" ", ncol(.)); . } %>%
    kbl(
        format = "html",
        caption = "Pairwise Brown-Forsythe Tests: Mixscape KO vs NP",
        align = "c",
        escape = FALSE
    ) %>%
    kable_styling(
        bootstrap_options = c("striped", "hover"),
        full_width = FALSE,
        position = "left"
    ) %>%
    add_header_above(
        c(
            "gRNA" = 1,
            "p-value" = 1,
            "p.adj (Holm)" = 1,
            "p-value" = 1,
            "p.adj (Holm)" = 1
        )
    ) %>%
    add_header_above(
        c(
            " " = 1, # gRNA column
            "No Cutoff" = 2,
            "With Cutoff (Depth > 20)" = 2
        )
    ) %>%
    column_spec(
        3,
        background = ifelse(
            !is.na(mixscape_combined$padj_nc) & mixscape_combined$padj_nc < 0.05,
            custom_salmon,
            "white"
        )
    ) %>%
    column_spec(
        5,
        background = ifelse(
            !is.na(mixscape_combined$padj_c) & mixscape_combined$padj_c < 0.05,
            custom_salmon,
            "white"
        )
    )
```

### Heteroplasmy variance by mtDNA depth

To quantify the expected range of technical variance as a function of sequencing depth, we performed quantile regression with bootstrap confidence intervals. We binned all cells (excluding `TFAM`, `POLG`, and `OPA1`) into 100 equal-sized depth bins to establish a background variance-depth relationship, while the three target perturbations were each binned into 15 depth bins.

We fit quantile regression models at the 5th and 95th percentiles using a $\frac{1}{\text{depth}}$ functional form, consistent with binomial sampling theory. To estimate uncertainty, we performed 200 bootstrap resamples of the control bins. The shaded ribbon represents the 95% confidence interval of the 5th-95th percentile range, while the dashed line shows the best-fit 95th percentile (upper bound of technical variance).


```{r}
#| label: het-variance-by-log-depth-bootstrap-ribbon
#| fig-cap: "Heteroplasmy variance decreases with sequencing depth following a 1/depth relationship predicted by binomial sampling. Gray ribbon shows the 95% confidence interval for the 5th-95th percentile range of technical variance, estimated by bootstrap quantile regression on all cells excluding TFAM, POLG, and OPA1. Gray points represent 100 equal-sized depth bins across the background population. Dashed line shows the best-fit 95th percentile (upper bound of technical variance). Colored points show variance within 15 depth bins for each target perturbation. TFAM, POLG, and OPA1 exhibit variance exceeding the technical baseline, particularly at higher depths where technical variance is minimal."
#| fig-align: center

# Target genes to check
target_gRNAs <- c("Tfam", "Polg", "Opa1")

# Background set of controls (all non-target gRNAs)
control_data <- mtDNA_data %>%
    filter(!top_guide_final_enrich_combined %in% target_gRNAs) %>%
    filter(!is.na(mtDNA_depth), mtDNA_depth > 0)

# Bin Controls
control_bin_stats <- control_data %>%
    mutate(depth_bin = cut_number(mtDNA_depth, n = 100)) %>%
    group_by(depth_bin) %>%
    summarise(
        n_cells = n(),
        mean_depth = mean(mtDNA_depth, na.rm = TRUE),
        var_het = var(Heteroplasmy_all_5024, na.rm = TRUE)
    ) %>%
    mutate(Group_Label = "Control")

ko_data <- mtDNA_data %>%
    filter(top_guide_final_enrich_combined %in% target_gRNAs) %>%
    filter(!is.na(mtDNA_depth), mtDNA_depth > 0)

ko_bin_stats <- ko_data %>%
    group_by(top_guide_final_enrich_combined) %>%
    mutate(depth_bin = cut_number(mtDNA_depth, n = 15)) %>%
    group_by(top_guide_final_enrich_combined, depth_bin) %>%
    summarise(
        n_cells = n(),
        mean_depth = mean(mtDNA_depth, na.rm = TRUE),
        var_het = var(Heteroplasmy_all_5024, na.rm = TRUE),
        .groups = "drop"
    ) %>%
    filter(n_cells >= 5) %>%
    rename(Group_Label = top_guide_final_enrich_combined)

# Bootstrap Quantile Regression
n_boot <- 200
min_depth_overall <- min(c(ko_bin_stats$mean_depth, control_bin_stats$mean_depth), na.rm=TRUE)
max_depth_overall <- max(c(250, ko_bin_stats$mean_depth, control_bin_stats$mean_depth), na.rm=TRUE)

pred_depths <- exp(seq(log(min_depth_overall), log(max_depth_overall), length.out = 200))

# Matrices to store bootstrap predictions
boot_low_preds <- matrix(NA, nrow = length(pred_depths), ncol = n_boot)
boot_high_preds <- matrix(NA, nrow = length(pred_depths), ncol = n_boot)

for(i in 1:n_boot) {
    boot_idx <- sample(nrow(control_bin_stats), replace = TRUE)
    boot_data <- control_bin_stats[boot_idx, ]

    try({
        fit_05 <- rq(var_het ~ I(1/mean_depth), data = boot_data, tau = 0.05)
        fit_95 <- rq(var_het ~ I(1/mean_depth), data = boot_data, tau = 0.95)

        boot_low_preds[, i] <- predict(fit_05, newdata = data.frame(mean_depth = pred_depths))
        boot_high_preds[, i] <- predict(fit_95, newdata = data.frame(mean_depth = pred_depths))
    }, silent = TRUE)
}

# Calculate quantiles for ribbon
ribbon_data <- data.frame(mean_depth = pred_depths)
ribbon_data$min_var <- apply(boot_low_preds, 1, quantile, probs = 0.025, na.rm = TRUE)
ribbon_data$max_var <- apply(boot_high_preds, 1, quantile, probs = 0.975, na.rm = TRUE)
ribbon_data$min_var[ribbon_data$min_var < 0] <- 0

# Best fit line (Control data)
fit_95_orig <- rq(var_het ~ I(1/mean_depth), data = control_bin_stats, tau = 0.95)
ribbon_data$best_fit_95 <- predict(fit_95_orig, newdata = data.frame(mean_depth = pred_depths))


plot_points <- bind_rows(control_bin_stats, ko_bin_stats)

# Define custom colors
custom_colors <- c("Control" = "grey40", "Tfam" = "#E41A1C", "Polg" = "#4DAF4A", "Opa1" = "#E377C2")

p_het_vs_log_depth <- ggplot() +
    geom_ribbon(
        data = ribbon_data,
        aes(x = mean_depth, ymin = min_var, ymax = max_var),
        fill = "grey70", alpha = 0.3
    ) +
    geom_line(
        data = ribbon_data, aes(x = mean_depth, y = best_fit_95),
        color = "grey50", linetype = "dashed", alpha = 0.8
    ) +
    geom_point(
        data = plot_points,
        aes(x = mean_depth, y = var_het, fill = Group_Label, size = Group_Label),
        alpha = 0.8,
        shape = 21,
        color = "black",
        stroke = 0.3
    ) +
    scale_x_log10(
        breaks = c(1, 10, 100, 250),
        labels = c("1", "10", "100", "250")
    ) +
    scale_fill_manual(values = custom_colors, name = "gRNA") +
    scale_size_manual(
        values = c("Control" = 1.5, "Tfam" = 2, "Polg" = 2, "Opa1" = 2),
        guide = "none"
    ) +
    guides(
        fill = guide_legend(override.aes = list(size = 4))
    ) +
    labs(
        x = "Mean mtDNA Depth (binned) (log scale)",
        y = "Heteroplasmy Variance"
    ) +
    theme_minimal() +
    theme(
        legend.position = c(0.85, 0.8),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 14),
        panel.grid.minor = element_blank()
    )

ggsave(
    here::here(plot_dir, "mtDNA_het_variance_by_log_depth_bootstrap_ribbon.pdf"),
    plot = p_het_vs_log_depth,
    width = 8,
    height = 6
)

p_het_vs_log_depth
```

`TFAM`, `POLG` and `OPA1` cells follow the same depth-variance trend as the control cells.

### Binomial Sampling Simulations

To distinguish technical from biological sources of heteroplasmy variance, we performed binomial sampling simulations to model the expected variance arising purely from technical noise at reduced mtDNA depths.

For each gRNA perturbation, we:

1. Sampled control cells (without replacement) to match the gRNA group size. \
2. Assigned each sampled cell a sequencing depth at the heteroplasmic sites (m.5024) drawn from the gRNA depth distribution (with replacement). \
3. Simulated alternative allele counts via binomial sampling: $X_i \sim \text{Binomial}(n = \text{depth}_{\text{5024}, i}, \ p = \text{het}_{\text{control}, i})$ \
4. Calculated simulated heteroplasmy: $\text{het}_{\text{sim}, i} = X_i / \text{depth}_{\text{5024}, i}$ \
5. Computed variance of simulated heteroplasmies across all cells,
6. Repeated 5,000 times to generate a null distribution of technical variance

We tested for differences between the observed variance and the simulated null distribution using a two-tailed test:

- $H_0$: Observed variance $=$ Simulated technical variance (technical noise only)
- $H_1$: Observed variance $\neq$ Simulated technical variance (biological effect present)

The empirical p-value was calculated as the proportion of simulations where the absolute difference between the simulated variance and the mean simulated variance was greater than or equal to the absolute difference between the observed variance and the mean simulated variance. P-values were adjusted for multiple comparisons (Bonferroni-Holm) across all perturbation groups.

::: {.callout-note appearance="simple"}
Control group included cells with the following gRNA: `Eomes`, `Neurod1`, `Olig1`, `Opn4`, `Rgr`, `Rrh`, `NT`
:::

```{r}
#| label: heteroplasmy-variance-simulation-function
#| echo: true
#| code-summary: "Function to simulate heteroplasmy variance for a given gRNA perturbation"

simulate_het_for_gRNA <- function(
    mtDNA_data,
    gRNA_name,
    n_perms = 5000,
    n_sim_points_to_plot = 2000,
    col_pal = NULL
) {

    # Filter KO and Control data
    KO_df <- mtDNA_data %>%
        dplyr::filter(top_guide_final_enrich_combined == gRNA_name) %>%
        dplyr::select(Heteroplasmy_all_5024, mtDNA_depth, Depth_all_5024) %>%
        dplyr::filter(
            Depth_all_5024 >= 0,
            Heteroplasmy_all_5024 >= 0,
            Heteroplasmy_all_5024 <= 1) %>%
        drop_na() %>%
        dplyr::mutate(group = gRNA_name)

    control_df <- mtDNA_data %>%
        dplyr::filter(group == "Control") %>%
        dplyr::select(Heteroplasmy_all_5024, mtDNA_depth, Depth_all_5024) %>%
        dplyr::filter(
            Depth_all_5024 >= 0,
            Heteroplasmy_all_5024 >= 0,
            Heteroplasmy_all_5024 <= 1) %>%
        drop_na() %>%
        dplyr::mutate(group = "Control")

    # Combine KO and Control data
    sim_input_df <- bind_rows(KO_df, control_df)

    # Get observed stats
    sim_input_stats <- sim_input_df %>%
        group_by(group) %>%
        dplyr::summarise(
            n_cells = n(),
            mean_depth = mean(Depth_all_5024, na.rm = TRUE),
            var_het = var(Heteroplasmy_all_5024, na.rm = TRUE)
        )

    obs_ko_var <- sim_input_stats %>% dplyr::filter(group == gRNA_name) %>% dplyr::pull(var_het)
    obs_control_var <- sim_input_stats %>% dplyr::filter(group == "Control") %>% dplyr::pull(var_het)

    all_sim_var <- numeric(n_perms)
    all_sim_hets_list <- vector("list", n_perms)
    all_input_hets_list <- vector("list", n_perms)

    # Iterate through each permutation
    for (perm in seq_len(n_perms)) {

        # Sample cells from control group equal to the number of cells in KO group
        control_sample <- sim_input_df %>%
            dplyr::filter(group == "Control") %>%
            sample_n(
                min(nrow(control_df), nrow(KO_df)),
                replace = FALSE) %>%
            dplyr::mutate(group = "Control")

        # Sample mtDNA depths from KO group
        sampled_depths <- sample(KO_df$Depth_all_5024,
                                    size = nrow(control_sample),
                                    replace = TRUE)

        # Sample heteroplasmy levels from control group
        sampled_hets <- control_sample$Heteroplasmy_all_5024
        all_input_hets_list[[perm]] <- sampled_hets

        # Simulate mtDNA copy number
        sim_alt_counts <- numeric(nrow(control_sample))
        sim_hets <- rep(NA_real_, nrow(control_sample))
        valid_indices <- which(sampled_depths > 0)

        # Simulate alt counts for valid indices
        # where sampled_depths > 0
        if (length(valid_indices) > 0) {
            sim_alt_counts[valid_indices] <- rbinom(
                n = length(valid_indices),
                size = sampled_depths[valid_indices],
                prob = sampled_hets[valid_indices]
            )
            # Calculate heteroplasmy for valid indices
            sim_hets[valid_indices] <- sim_alt_counts[valid_indices] / sampled_depths[valid_indices]
        }
        all_sim_var[perm] <- var(sim_hets, na.rm = TRUE)
        all_sim_hets_list[[perm]] <- sim_hets[!is.na(sim_hets)]
    }

    # Flatten the list of simulated heteroplasmies
    all_sim_hets_flat <- na.omit(unlist(all_sim_hets_list))

    # Observed KO stats
    obs_ko_homoplasmy_prop <- mean(KO_df$Heteroplasmy_all_5024 %in% c(0,1), na.rm = TRUE)
    obs_ko_mean_het <- mean(KO_df$Heteroplasmy_all_5024, na.rm = TRUE)

    # Simulated stats
    sim_ko_homoplasmy_prop <- mean(all_sim_hets_flat %in% c(0,1), na.rm = TRUE)
    sim_ko_mean_het <- mean(all_sim_hets_flat, na.rm = TRUE)
    sim_ko_var <- var(all_sim_hets_flat, na.rm = TRUE)

    # Empirical p-values

    # Two-tailed: proportion of simulated variances as extreme or more extreme than observed
    mean_sim_var <- mean(all_sim_var)
    p_val_two_tailed <- mean(abs(all_sim_var - mean_sim_var) >= abs(obs_ko_var - mean_sim_var))

    plot_df_hets <- data.frame(
        Heteroplasmy = c(
            control_df$Heteroplasmy_all_5024,
            all_sim_hets_flat,
            KO_df$Heteroplasmy_all_5024
        ),
        Group = factor(c(
            rep("Control", nrow(control_df)),
            rep("Simulated", length(all_sim_hets_flat)),
            rep(gRNA_name, nrow(KO_df))
        ), levels = c("Control", "Simulated", gRNA_name))
    )

    # Subsample points to avoid cluttering
    # Set the number of points to plot for the jitter layer
    n_sim_points <- min(length(all_sim_hets_flat), n_sim_points_to_plot)

    # Filter the main dataframe, subsample only the 'Simulated' group
    jitter_data <- plot_df_hets %>%
        group_by(Group) %>%
        # If the group is 'Simulated', sample n_sim_points, otherwise take all rows
        dplyr::filter(
            if (cur_group()$Group == "Simulated") row_number() %in% sample(row_number(), n_sim_points) else TRUE
        ) %>%
        ungroup()

    # Set colors for Control, Simulated, and gRNA
    if (!is.null(col_pal)) {
        group_colors <- c(
            "Control" = scales::alpha(shades::saturation(col_pal["NT"], 0.8), 0.6),
            "Simulated" = scales::alpha(shades::saturation(col_pal[gRNA_name], 0.4), 0.6),
            gRNA_name = scales::alpha(shades::saturation(col_pal[gRNA_name], 0.8), 0.6)
        )
        names(group_colors)[3] <- gRNA_name
    } else {
        group_colors <- c(
            "Control" = "#2CA02CFF",
            "Simulated" = "#1F77B4FF",
            gRNA_name = "#D62728FF"
        )
        names(group_colors)[3] <- gRNA_name
    }

    het_dist_sim <- ggplot(
        plot_df_hets,
        aes(x = Group, y = Heteroplasmy, fill = Group)
    ) +
        geom_violin(
            data = jitter_data,
            width = 1.2,
            alpha = 0.3,
            color = NA
        ) +
        geom_jitter(
            data = jitter_data,
            width = 0.15,
            size = 1.2,
            alpha = 0.3,
            aes(color = Group)
        ) +
        geom_boxplot(
            data = jitter_data,
            width = 0.2,
            outlier.shape = NA,
            alpha = 0.6,
            position = "identity"
        ) +
        scale_fill_manual(values = group_colors) +
        scale_color_manual(values = group_colors) +
        theme_minimal(base_size = 14) +
        labs(
            title = paste("Distribution of Heteroplasmies (", gRNA_name, " KO Simulation)", sep = ""),
            x = NULL,
            y = "Heteroplasmy (m.5024)"
        ) +
        theme(legend.position = "none")

    return(list(
        plot = het_dist_sim,
        sim_input_stats = sim_input_stats,
        all_sim_var = all_sim_var,
        all_sim_hets_list = all_sim_hets_list,
        obs_ko_mean_het = obs_ko_mean_het,
        obs_ko_var = obs_ko_var,
        obs_ko_homoplasmy_prop = obs_ko_homoplasmy_prop,
        sim_ko_mean_het = sim_ko_mean_het,
        sim_ko_var = sim_ko_var,
        sim_ko_homoplasmy_prop = sim_ko_homoplasmy_prop,
        p_value_two_tailed = p_val_two_tailed
    ))
}
```

```{r}
#| label: run-heteroplasmy-simulations
#| fig-align: center
#| fig-fullwidth: true

gRNA_list <- levels(mtDNA_data$top_guide_final_enrich_combined)

het_sim_results <- map(gRNA_list, ~ {
    simulate_het_for_gRNA(
        mtDNA_data = mtDNA_data,
        gRNA_name = .x,
        n_perms = 5000,
        n_sim_points_to_plot = 2000,
        col_pal = col_pal
    )
})
het_sim_results <- set_names(het_sim_results, gRNA_list)
```

```{r}
#| label: heteroplasmy-simulation-summary

het_sim_summary <- bind_rows(
    lapply(names(het_sim_results), function(gRNA) {
        res <- het_sim_results[[gRNA]]
        data.frame(
            gRNA = gRNA,
            obs_ko_mean_het = res$obs_ko_mean_het,
            sim_ko_mean_het = res$sim_ko_mean_het,
            obs_ko_var = res$obs_ko_var,
            sim_ko_var = res$sim_ko_var,
            obs_ko_homoplasmy_prop = res$obs_ko_homoplasmy_prop,
            sim_ko_homoplasmy_prop = res$sim_ko_homoplasmy_prop,
            p_value_two_tailed = res$p_value_two_tailed
        )
    })
)

# Calculate adjusted p-values for all gRNAs
het_sim_summary$p_adj_holm_two_tailed <- p.adjust(het_sim_summary$p_value_two_tailed, method = "holm")

het_sim_summary <- het_sim_summary %>%
    dplyr::rename(
        `gRNA` = gRNA,
        `Observed Mean Heteroplasmy` = obs_ko_mean_het,
        `Simulated Mean Heteroplasmy` = sim_ko_mean_het,
        `Observed Heteroplasmy Variance` = obs_ko_var,
        `Simulated Heteroplasmy Variance` = sim_ko_var,
        `Observed Homoplasmy Proportion` = obs_ko_homoplasmy_prop,
        `Simulated Homoplasmy Proportion` = sim_ko_homoplasmy_prop,
        `p-value (2-tailed)` = p_value_two_tailed,
        `p.adj Holm (2-tailed)` = p_adj_holm_two_tailed
    )

# Format p-values and create display table
het_sim_summary_display <- het_sim_summary %>%
    dplyr::mutate(
        across(starts_with("p-value"), ~ formatC(.x, format = "e", digits = 2)),
        across(starts_with("p.adj"), ~ formatC(.x, format = "e", digits = 2))
    ) %>%
    dplyr::select(
        `gRNA`,
        `Observed Mean Heteroplasmy`,
        `Simulated Mean Heteroplasmy`,
        `Observed Heteroplasmy Variance`,
        `Simulated Heteroplasmy Variance`,
        `Observed Homoplasmy Proportion`,
        `Simulated Homoplasmy Proportion`,
        `p-value (2-tailed)`,
        `p.adj Holm (2-tailed)`
    )

# Get column names before blanking
orig_colnames <- colnames(het_sim_summary_display)

# Create table with blank column names for display
het_sim_summary_display %>%
    { colnames(.) <- rep(" ", ncol(.)); . } %>%
    kbl(
        format = "html",
        caption = "Summary of Observed and Simulated Heteroplasmy Metrics",
        align = "c",
        escape = FALSE
    ) %>%
    kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover")) %>%
    add_header_above(
        c(
            " " = 1,
            "Observed" = 1,
            "Simulated" = 1,
            "Observed" = 1,
            "Simulated" = 1,
            "Observed" = 1,
            "Simulated" = 1,
            "p-value" = 1,
            "p.adj" = 1
        )
    ) %>%
    add_header_above(
        c(
            " " = 1,
            "Mean Heteroplasmy" = 2,
            "Heteroplasmy Variance" = 2,
            "Homoplasmy Proportion" = 2,
            "Two-tailed" = 2
        )
    ) %>%
    column_spec(
        which(orig_colnames == "p-value (2-tailed)"),
        background = ifelse(
            as.numeric(het_sim_summary$`p-value (2-tailed)`) < 0.05,
            scales::alpha(custom_salmon, 0.3),
            "white"
        )
    ) %>%
    column_spec(
        which(orig_colnames == "p.adj Holm (2-tailed)"),
        background = ifelse(
            as.numeric(het_sim_summary$`p.adj Holm (2-tailed)`) < 0.05,
            custom_salmon,
            "white"
        ),
        bold = ifelse(
            as.numeric(het_sim_summary$`p.adj Holm (2-tailed)`) < 0.05,
            TRUE,
            FALSE
        )
    )

```

```{r}
#| label: homoplasmy-ci-assessment
#| echo: true
#| code-summary: "Calculate 95% CI for simulated homoplasmy proportions and assess concordance with observed"

# Calculate CI for homoplasmy proportions from simulation iterations
homoplasmy_ci_results <- bind_rows(
    lapply(names(het_sim_results), function(gRNA) {
        res <- het_sim_results[[gRNA]]

        # Calculate homoplasmy proportion for each simulation iteration
        sim_homoplasmy_props <- sapply(res$all_sim_hets_list, function(sim_hets) {
            mean(sim_hets %in% c(0, 1), na.rm = TRUE)
        })

        # Calculate 95% CI
        ci_lower <- quantile(sim_homoplasmy_props, 0.025, na.rm = TRUE)
        ci_upper <- quantile(sim_homoplasmy_props, 0.975, na.rm = TRUE)

        # Check if observed falls within CI
        obs_in_ci <- res$obs_ko_homoplasmy_prop >= ci_lower &
                     res$obs_ko_homoplasmy_prop <= ci_upper

        # Calculate difference between observed and simulated
        diff <- res$obs_ko_homoplasmy_prop - res$sim_ko_homoplasmy_prop

        data.frame(
            gRNA = gRNA,
            obs_homoplasmy = res$obs_ko_homoplasmy_prop,
            sim_homoplasmy_mean = res$sim_ko_homoplasmy_prop,
            sim_homoplasmy_ci_lower = ci_lower,
            sim_homoplasmy_ci_upper = ci_upper,
            obs_in_ci = obs_in_ci,
            diff = diff
        )
    })
)
```

```{r}
#| label: fig-homoplasmy-concordance-forest-plot
#| fig-cap: "Forest plot showing concordance between observed and simulated homoplasmy proportions. Points represent observed values, horizontal lines show 95% CI from 5,000 bootstrap simulations. Green points indicate observed values falling within the simulated CI (concordant), red points indicate discordance. gRNAs are ordered by functional group and observed homoplasmy proportion."
#| fig-align: center
#| fig-fullwidth: true
#| fig-width: 10
#| fig-height: 8

# Prepare data for forest plot
# Need to get observed variance from het_sim_summary
forest_plot_data <- homoplasmy_ci_results %>%
    left_join(
        het_sim_summary %>%
            select(gRNA, obs_var = `Observed Heteroplasmy Variance`),
        by = "gRNA"
    ) %>%
    # Order by observed heteroplasmy variance (descending)
    arrange(obs_var) %>%
    mutate(
        gRNA = factor(gRNA, levels = gRNA)
    )

# Create forest plot
forest_plot <- ggplot(forest_plot_data,
                     aes(y = gRNA, x = obs_homoplasmy)) +
    # Add 95% CI error bars (no color by concordance)
    geom_errorbarh(
        aes(xmin = sim_homoplasmy_ci_lower,
            xmax = sim_homoplasmy_ci_upper),
        height = 0.3,
        size = 1,
        alpha = 0.7,
        color = "royalblue"
    ) +
    # Add simulated mean as diamond
    geom_point(
        aes(x = sim_homoplasmy_mean),
        shape = 23,  # diamond
        size = 3,
        fill = "gray50",
        color = "gray30"
    ) +
    # Add observed value as circle (no color by concordance)
    geom_point(
        size = 4,
        shape = 19,  # filled circle
        color = "royalblue"
    ) +
    # Add vertical line at 0
    geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
    # Formatting
    scale_x_continuous(
        labels = scales::percent_format(accuracy = 1),
        limits = c(0, max(forest_plot_data$obs_homoplasmy,
                         forest_plot_data$sim_homoplasmy_ci_upper) * 1.05)
    ) +
    labs(
        x = "Homoplasmy Proportion (0% or 100% heteroplasmy)",
        y = "gRNA Perturbation",
        title = "Observed and Simulated Homoplasmy Proportions"
    ) +
    theme_minimal(base_size = 12) +
    theme(
        legend.position = "none",
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_text(size = 10)
    )

# Print the plot
forest_plot

# Save the plot
ggsave(
    here::here(plot_dir, "homoplasmy_concordance_forest_plot.pdf"),
    plot = forest_plot,
    width = 10,
    height = 8
)
```


The table shows both one-tailed and two-tailed p-values with Holm correction for multiple testing. Raw p-values < 0.05 are highlighted with light shading, while Holm-adjusted p-values < 0.05 are highlighted with darker shading and bold text.

Based on the one-tailed adjusted p-values (testing if observed variance > simulated variance), only `Tfam` and `Opa1` gRNAs show significantly higher heteroplasmy variance compared to the simulated technical variance from the `Control` group, suggesting these gRNAs have a true biological effect on heteroplasmy variance. The `Polg` gRNA does not show a significant difference after multiple testing correction.

```{r}
#| label: fig-obs-vs-sim-het-distributions
#| fig-cap: "Comparison of observed and simulated heteroplasmy distributions for TFAM, OPA1, and POLG perturbations. Violin plots show the distribution of heteroplasmy values at m.5024. 'Observed' distributions represent actual KO cells. 'Simulated' distributions represent technical variance expected from binomial sampling of control cells at KO depth distributions. TFAM and OPA1 show broader observed distributions than simulated, indicating biological variance exceeds technical noise."
#| fig-align: center
#| fig-fullwidth: true

obs_KO_het_df <- mtDNA_data %>%
    dplyr::filter(top_guide_final_enrich_combined %in% c("Tfam", "Opa1", "Polg")) %>%  dplyr::filter(
        Depth_all_5024 >= 0,
        Heteroplasmy_all_5024 >= 0,
        Heteroplasmy_all_5024 <= 1) %>%
    drop_na() %>%
    dplyr::mutate(group = top_guide_final_enrich_combined) %>%
    dplyr::select(group, Heteroplasmy_all_5024)

obs_control_het_df <- mtDNA_data %>%
    dplyr::filter(group == "Control") %>%
    dplyr::filter(
        Depth_all_5024 >= 0,
        Heteroplasmy_all_5024 >= 0,
        Heteroplasmy_all_5024 <= 1) %>%
    drop_na() %>%
    dplyr::select(group, Heteroplasmy_all_5024)

sim_results <- list(
    Tfam = het_sim_results$Tfam$all_sim_hets_list,
    Opa1 = het_sim_results$Opa1$all_sim_hets_list,
    Polg = het_sim_results$Polg$all_sim_hets_list
)

sim_KO_het_df <- imap_dfr(sim_results, ~ data.frame(
    group = paste0("Simulated_", .y),
    Heteroplasmy_all_5024 = unlist(.x)
))

all_het_df <- dplyr::bind_rows(
    obs_control_het_df %>% dplyr::mutate(Group = "Control"),
    obs_KO_het_df %>% dplyr::mutate(Group = group),
    sim_KO_het_df %>% dplyr::mutate(Group = group)
)

all_het_df$Group <- factor(
    all_het_df$Group,
    levels = c("Control", "Simulated_Tfam", "Tfam", "Simulated_Opa1", "Opa1", "Simulated_Polg", "Polg")
)

group_colors <- c(
    "Control" = scales::alpha(shades::saturation(col_pal["NT"], 0.8), 0.6),
    "Simulated_Tfam" = scales::alpha(shades::saturation(col_pal["Tfam"], 0.4), 0.6),
    "Tfam" = scales::alpha(shades::saturation(col_pal["Tfam"], 0.8), 0.6),
    "Simulated_Opa1" = scales::alpha(shades::saturation(col_pal["Opa1"], 0.4), 0.6),
    "Opa1" = scales::alpha(shades::saturation(col_pal["Opa1"], 0.8), 0.6),
    "Simulated_Polg" = scales::alpha(shades::saturation(col_pal["Polg"], 0.4), 0.6),
    "Polg" = scales::alpha(shades::saturation(col_pal["Polg"], 0.8), 0.6)
)

n_sim_points <- 2000

jitter_data <- all_het_df %>%
    group_by(Group) %>%
    dplyr::mutate(
        keep = if (grepl("^Simulated_", unique(Group))) {
            row_number() %in% sample(row_number(), min(n_sim_points, n()))
        } else {
            TRUE
        }
    ) %>%
    dplyr::filter(keep) %>%
    ungroup() %>%
    dplyr::select(-keep)

het_dist_all <- ggplot(
    all_het_df,
    aes(x = Group, y = Heteroplasmy_all_5024, fill = Group)
) +
    geom_violin(
        data = jitter_data,
        width = 1.2,
        alpha = 0.3,
        color = NA
    ) +
    geom_jitter(
        data = jitter_data,
        width = 0.15,
        size = 1.2,
        alpha = 0.3,
        aes(color = Group)
    ) +
    geom_boxplot(
        data = jitter_data,
        width = 0.2,
        outlier.shape = NA,
        alpha = 0.6
    ) +
    scale_fill_manual(values = group_colors) +
    scale_color_manual(values = group_colors) +
    scale_x_discrete(labels = c(
        "Control" = "Control\nObserved",
        "Simulated_Tfam" = "Tfam\nSimulated",
        "Tfam" = "Tfam\nObserved",
        "Simulated_Opa1" = "Opa1\nSimulated",
        "Opa1" = "Opa1\nObserved",
        "Simulated_Polg" = "Polg\nSimulated",
        "Polg" = "Polg\nObserved"
    )) +
    theme_minimal(base_size = 14) +
    labs(
        x = NULL,
        y = "Heteroplasmy (m.5024)"
    ) +
    theme(legend.position = "none")

ggsave(
    here::here(plot_dir, "obs_vs_sim_het_dist.pdf"),
    plot = het_dist_all,
    width = 8,
    height = 6
)

het_dist_all + ggtitle("Heteroplasmy Distribution: Observed vs Simulated") +
    theme(plot.title = element_text(hjust = 0.5))
```

```{r}
#| label: fig-sim-variance-dist
#| fig-cap: "Distribution of simulated heteroplasmy variance for TFAM, POLG, and OPA1. Histograms and density curves show 5,000 bootstrap simulations of technical variance for each gRNA. Dashed vertical lines indicate observed variance in KO cells (colored) and control cells (gray). Two-tailed p-values (Holm-adjusted) test whether observed variance differs significantly from simulated technical variance."
#| fig-align: center
#| fig-fullwidth: true

sim_var_gRNA_df <- dplyr::bind_rows(
    data.frame(Simulated_Variance = het_sim_results$Tfam$all_sim_var, gRNA = "Tfam"),
    data.frame(Simulated_Variance = het_sim_results$Polg$all_sim_var, gRNA = "Polg"),
    data.frame(Simulated_Variance = het_sim_results$Opa1$all_sim_var, gRNA = "Opa1")
)

obs_ko_var_gRNA <- c(
    Tfam = het_sim_results$Tfam$sim_input_stats %>% dplyr::filter(group == "Tfam") %>% dplyr::pull(var_het),
    Polg = het_sim_results$Polg$sim_input_stats %>% dplyr::filter(group == "Polg") %>% dplyr::pull(var_het),
    Opa1 = het_sim_results$Opa1$sim_input_stats %>% dplyr::filter(group == "Opa1") %>% dplyr::pull(var_het)
)

obs_control_var <- het_sim_results$Tfam$sim_input_stats %>%
    dplyr::filter(group == "Control") %>%
    dplyr::pull(var_het)

# Get two-tailed adjusted p-values from het_sim_summary table
pvals_ko_adj <- het_sim_summary %>%
    dplyr::filter(gRNA %in% c("Tfam", "Polg", "Opa1")) %>%
    dplyr::select(gRNA, p_adj = `p.adj Holm (2-tailed)`) %>%
    arrange(match(gRNA, c("Tfam", "Polg", "Opa1"))) %>%
    dplyr::pull(p_adj)
names(pvals_ko_adj) <- c("Tfam", "Polg", "Opa1")

dens_max <- sim_var_gRNA_df %>%
    split(.$gRNA) %>%
    lapply(function(df) max(density(df$Simulated_Variance, from = 0, to = 0.1)$y)) %>%
    unlist() %>%
    max()

# Prepare annotation data
annotation_df <- data.frame(
    gRNA = names(obs_ko_var_gRNA),
    obs_var = obs_ko_var_gRNA,
    pval_adj = pvals_ko_adj,
    y = dens_max * 0.7
)

combined_sim_var_plot <- ggplot(
    sim_var_gRNA_df,
    aes(
        x = Simulated_Variance,
        fill = gRNA,
        color = gRNA)
    ) +
    geom_histogram(
        aes(y = ..density..),
        bins = 50,
        position = "identity",
        alpha = 0.4
    ) +
    geom_density(
        aes(y = ..density..),
        alpha = 0.4,
        size = 1
    ) +
    geom_vline(
        data = data.frame(
            gRNA = names(obs_ko_var_gRNA),
            obs_var = obs_ko_var_gRNA
        ),
        aes(xintercept = obs_var, color = gRNA),
        linetype = "dashed",
        size = 1
    ) +
    geom_vline(
        xintercept = obs_control_var,
        color = "grey40",
        linetype = "dashed",
        size = 1
    ) +
    scale_fill_manual(values = col_pal[c("Tfam", "Polg", "Opa1")]) +
    scale_color_manual(values = col_pal[c("Tfam", "Polg", "Opa1")]) +
    theme_minimal(base_size = 14) +
    theme(legend.position = "None") +
    xlab("Simulated Heteroplasmy Variance") +
    ylab("Density") +
    geom_text(
        data = annotation_df,
        aes(
            x = obs_var + 0.0008,
            y = y,
            label = paste0(gRNA, " variance\np.adj=", signif(pval_adj, 3)),
            color = gRNA
        ),
        vjust = -0.5,
        hjust = 0,
        size = 4,
        show.legend = FALSE,
        inherit.aes = FALSE
    ) +
    annotate(
        "text",
        x = obs_control_var + 0.0008,
        y = dens_max,
        label = "Control Variance",
        color = col_pal["Oma1"],
        vjust = -0.5,
        hjust = 0,
        size = 4
    )

ggsave(
    filename = here::here(plot_dir, "simulated_variance_distribution_low_mtDNA_gRNAs.pdf"),
    plot = combined_sim_var_plot,
    width = 8,
    height = 6,
    dpi = 300
)
combined_sim_var_plot

```

```{r}
#| label: fig-sim-variance-dist-all-gRNAs-ridge
#| fig-cap: "Distribution of simulated heteroplasmy variance for all gRNA perturbations. Each row shows the 5,000-simulation null distribution (shaded density) for a gRNA. The white dot indicates the observed variance for that gRNA, while the vertical dashed line shows the observed control variance for reference. Holm-adjusted p-values (2-tailed) are listed on the right."
#| fig-align: center
#| fig-fullwidth: true
#| fig-height: 12
#| fig-width: 10

gRNA_list <- gRNA_order

sim_var_gRNA_df <- purrr::map_dfr(gRNA_list, ~ data.frame(
    Simulated_Variance = het_sim_results[[.x]]$all_sim_var,
    gRNA = .x
))

# Get observed and adjusted p-value data for annotations
annotation_data <- het_sim_summary %>%
    dplyr::filter(gRNA %in% gRNA_list) %>%
    dplyr::select(
        gRNA,
        obs_var = `Observed Heteroplasmy Variance`,
        pval_adj = `p.adj Holm (2-tailed)`
    ) %>%
    dplyr::mutate(
        gRNA = factor(gRNA, levels = gRNA_list),
        # Create a clean label, checking for < 0.001
        pval_label = if_else(
            pval_adj < 0.001, "p.adj < 0.001",
            paste0("p.adj = ", round(pval_adj, 3))
        ),
        # Add positions for the label in the top-right corner
        x_pos = Inf,
        y_pos = Inf
    )

# Reorder gRNAs by observed variance for better visualization
plot_data <- sim_var_gRNA_df %>%
    left_join(annotation_data %>% select(gRNA, obs_var), by = "gRNA") %>%
    mutate(gRNA = fct_reorder(gRNA, obs_var))

# Reorder annotation_data to match
annotation_data_reordered <- annotation_data %>%
    mutate(gRNA = factor(gRNA, levels = levels(plot_data$gRNA)))

all_gRNAs_ridge_plot <- ggplot(
    plot_data,
    aes(x = Simulated_Variance, y = gRNA, fill = gRNA)
) +
    # The simulated distributions
    geom_density_ridges(
        alpha = 0.8,
        scale = 2, # Add some overlap
        color = "white",
    ) +
    # Add the OBSERVED variance as a point
    geom_point(
        data = annotation_data_reordered,
        aes(x = obs_var),
        shape = 21, # Circle with outline
        size = 2.5,
        alpha = 0.8,
        stroke = 1.2,
        color = "black"
    ) +
    scale_fill_manual(values = col_pal) +
    theme_minimal(base_size = 14) +
    theme(
        legend.position = "none",
        axis.text.y = element_text(face = "bold", size = 9),
        panel.grid.major.y = element_blank()
    ) +
    labs(
        x = "Heteroplasmy Variance",
        y = "gRNA"
    ) +
    # Zoom in on the relevant x-axis range
    coord_cartesian(xlim = c(0.005, 0.08))


# Save the plot
ggsave(
    filename = here::here(plot_dir, "simulated_variance_ridge_plot.pdf"),
    plot = all_gRNAs_ridge_plot,
    width = 10,
    height = 12,
    dpi = 300
)

# Print the plot
all_gRNAs_ridge_plot
```


P-values in the above plot are one-tailed, testing the null hypothesis that the observed heteroplasmy variance in the `gRNA KO` group is not significantly greater than the distribution of simulated variances derived from the `Control` group. P-values were adjusted for multiple testing using the Holm method.

```{r}
#| label: session_info
#| echo: false
#| output: asis

cat("::: {.callout-note collapse='true'}\n")
cat("## Session Information\n\n")
cat("```\n")
print(sessionInfo())
cat("\n```\n")
cat(":::\n")
```